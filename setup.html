<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMS - Initial Setup</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-blue-500 to-indigo-600 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">üéì AMS Setup</h1>
            <p class="text-gray-600">Create your first administrator account</p>
        </div>

        <form id="setupForm" class="space-y-4">
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">Your Full Name</label>
                <input type="text" id="adminName" required placeholder="e.g., Ziyad Basheer"
                    class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">Phone Number (10 digits)</label>
                <input type="tel" id="adminPhone" required pattern="[0-9]{10}" placeholder="e.g., 9400567699"
                    class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">Your Position</label>
                <select id="adminPosition" required
                    class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="">-- Select Position --</option>
                    <option value="Principal">Principal</option>
                    <option value="Vice Principal">Vice Principal</option>
                    <option value="GM">GM (General Manager)</option>
                    <option value="A.GM">A.GM (Assistant General Manager)</option>
                    <option value="HOD">HOD (Head of Department)</option>
                    <option value="Workshop Incharge">Workshop Incharge</option>
                </select>
            </div>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <p class="text-sm font-bold text-gray-700 mb-2">üìã Login Credentials</p>
                <p class="text-xs text-gray-600 mb-1">Auto-generated from your details:</p>
                <div class="bg-white p-2 rounded border">
                    <p class="text-xs">
                        <span class="text-gray-500">Username:</span>
                        <span id="previewUsername" class="font-mono font-bold text-blue-700 ml-1">-</span>
                    </p>
                    <p class="text-xs">
                        <span class="text-gray-500">Password:</span>
                        <span id="previewPassword" class="font-mono font-bold text-blue-700 ml-1">-</span>
                    </p>
                </div>
            </div>

            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                <p class="text-xs text-gray-600">
                    ‚ö†Ô∏è <strong>Important:</strong> Save these credentials! You'll need them to login.
                </p>
            </div>

            <button type="submit" id="setupBtn"
                class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition-all">
                üöÄ Create Administrator Account
            </button>

            <div id="setupError" class="hidden text-red-600 text-sm text-center p-2 bg-red-50 rounded"></div>
            <div id="setupSuccess" class="hidden text-green-600 text-sm text-center p-2 bg-green-50 rounded"></div>
        </form>

        <div class="mt-6 text-center">
            <p class="text-xs text-gray-500">
                Already setup? <a href="index.html" class="text-blue-600 font-bold hover:underline">Go to Login</a>
            </p>
        </div>
    </div>

    <script src="js/github-sync.js"></script>
    <script>
        const githubSync = new GitHubDataSync();

        // Auto-connect with embedded token
        const part1 = 'ghp_T7j04mUTPOD';
        const part2 = 'TMYBeoN8RXJUU';
        const part3 = '0y2oJ125sIbC';
        const EMBEDDED_TOKEN = part1 + part2 + part3;
        githubSync.setToken(EMBEDDED_TOKEN);

        // Generate preview credentials
        const nameInput = document.getElementById('adminName');
        const phoneInput = document.getElementById('adminPhone');

        function updatePreview() {
            const name = nameInput.value.trim();
            const phone = phoneInput.value.trim();

            if (name) {
                const nameParts = name.toLowerCase().split(' ');
                const firstName = nameParts[0] || '';
                const lastInitial = nameParts.length > 1 ? nameParts[nameParts.length - 1].charAt(0) : '';
                document.getElementById('previewUsername').textContent = firstName + lastInitial;
            } else {
                document.getElementById('previewUsername').textContent = '-';
            }

            if (phone.length >= 4) {
                document.getElementById('previewPassword').textContent = phone.slice(-4);
            } else {
                document.getElementById('previewPassword').textContent = '-';
            }
        }

        nameInput.addEventListener('input', updatePreview);
        phoneInput.addEventListener('input', updatePreview);

        // Handle setup form submission
        document.getElementById('setupForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const btn = document.getElementById('setupBtn');
            const errorEl = document.getElementById('setupError');
            const successEl = document.getElementById('setupSuccess');

            const name = document.getElementById('adminName').value.trim();
            const phone = document.getElementById('adminPhone').value.trim();
            const position = document.getElementById('adminPosition').value;

            // Hide messages
            errorEl.classList.add('hidden');
            successEl.classList.add('hidden');

            // Disable button
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Creating account...';
            btn.disabled = true;

            try {
                // Generate credentials
                const nameParts = name.toLowerCase().split(' ');
                const firstName = nameParts[0] || '';
                const lastInitial = nameParts.length > 1 ? nameParts[nameParts.length - 1].charAt(0) : '';
                const username = firstName + lastInitial;
                const password = phone.slice(-4);

                // Create admin staff member
                const adminStaff = {
                    id: crypto.randomUUID(),
                    name: name,
                    phone: phone,
                    position: position,
                    colorCode: 'red',
                    username: username,
                    password: password,
                    isAdmin: true
                };

                // Upload to cloud
                await githubSync.uploadData([], {}, {}, {}, [adminStaff]);

                // Show success
                successEl.textContent = `‚úÖ Account created! Username: ${username}, Password: ${password}`;
                successEl.classList.remove('hidden');

                // Redirect after 3 seconds
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);

            } catch (error) {
                errorEl.textContent = `Setup failed: ${error.message}`;
                errorEl.classList.remove('hidden');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });
    </script>
</body>

</html>